api:
  type: php:8.2
  size: S
  disk: 768

  timezone: Europe/Paris

  runtime:
    extensions:
      - xsl
      - mbstring
      - sodium
      - ctype
      - iconv
      - pdo_pgsql
      - pdo_mysql
      - amqp

  build:
    flavor: none

  web:
    locations:
      '/api':
        root: 'public'
        passthru: '/api/index.php'
        # No caching for static files.
        # (Dynamic pages use whatever cache headers are generated by the program.)
        index:
          - index.php
        expires: -1
        scripts: true
        allow: true

  relationships:
    database: "database:postgresql"

  mounts:
    "public/bundles": { source: local, source_path: public/bundles }
    "var": { source: local, source_path: var }
    "config/jwt": { source: local, source_path: config/jwt }

  hooks:
    build: |
      set -x -e
      
      curl -s https://get.symfony.com/cloud/configurator | (>&2 bash)
      (>&2 COMPOSER_FLAGS="--ignore-platform-reqs" symfony-build)
      
      if [ "$PLATFORM_BRANCH" = "main" ]; then
          symfony console assets:install
      fi

    deploy: |
      set -x -e
      
      (>&2 symfony-deploy)
      
      if [ "$PLATFORM_BRANCH" != "main" ]; then
          symfony console app:database:anonymize
      fi
      
      symfony console lexik:jwt:generate-keypair --skip-if-exists

  source:
    root: api

web:
  type: nodejs:20
  size: S
  disk: 150

  timezone: Europe/Paris

  build:
    flavor: none

  dependencies:
    nodejs:
      yarn: "^1.22.17"

  mounts:
    '/_next':
      source: local
      source_path: '_next'

  hooks:
    build: |
      set -x -e

      env
      yarn install
      yarn build

  web:
    commands:
      start: npx next start -p $PORT
  source:
    root: web
